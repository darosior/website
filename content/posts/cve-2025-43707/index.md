+++
date = 2025-04-24
draft = false
type = "blog"
title = "CVE-2025-43707: out-of-bounds read in the Rust-Miniscript satisfier"
description = "Public disclosure of a crash bug in the Rust-Miniscript library"
weight = 10
author = "Antoine Poinsot"
tags = ["Miniscript", "Rust-Miniscript", "Infosec"]
+++

On March 25, @Pythcoiner from the [Wizardsardine](https://wizardsardine.com) team contacted me about
a crash bug in [Liana](https://github.com/wizardsardine/liana) they had identified as coming from the
[`rust-miniscript`](https://github.com/rust-bitcoin/rust-miniscript) dependency. After investigating
i identified the crash as coming from the library's Miniscript satisfier, and found it could be
triggered by an attacker.

The impact of this vulnerability is that an attacker could make a victim crash by getting them to
satisfy a transaction spending a specially-crafted descriptor. In simpler terms, a victim could
crash when "signing" a transaction that spends from a specific "wallet". This is not critical (but
still pretty annoying!) if you consider the victim as being a software running locally. But these
are pretty common operations and it would not be surprising that an application running on a server
publicly exposes them (for instance through [BDK](https://bitcoindevkit.org/adoption/all)). There,
an attacker exploiting this bug could prevent all users from accessing the service.

The bug itself is an out-of-bounds read in the [`Satisfaction::thresh()`][GH permalink] function.
This code assumes that the size of the `sat_indices` vector is strictly superior to the threshold
`k`. This is not always the case, as `thresh(2,A,B)` is valid Miniscript. Therefore trying to
satisfy any `thresh()` fragment with a threshold `k` equal to the number of sub-fragments will
trigger an out-of-bounds read in the `sat_indices` vector. It can be fixed with the following diff:
```patch
diff --git a/src/miniscript/satisfy.rs b/src/miniscript/satisfy.rs
index d141340..cca7051 100644
--- a/src/miniscript/satisfy.rs
+++ b/src/miniscript/satisfy.rs
@@ -1026,7 +1026,8 @@ impl<Pk: MiniscriptKey + ToPublicKey> Satisfaction<Placeholder<Pk>> {
         // For example, the fragment thresh(2, hash, hash, 0, 0)
         // is uniquely satisfyiable because there is no satisfaction
         // for the 0 fragment
-        else if !sats[sat_indices[thresh.k()]].has_sig
+        else if sat_indices.len() > thresh.k()
+            && !sats[sat_indices[thresh.k()]].has_sig
             && sats[sat_indices[thresh.k()]].stack != Witness::Impossible
         {
             // All arguments should be `d`, so dissatisfactions have no
```

I reported this issue according to [`rust-bitcoin`'s security
policy](https://github.com/rust-bitcoin/rust-bitcoin/blob/master/SECURITY.md) by emailing Andrew
Poelstra on March 25th, who acknowledged receipt on the same day. Andrew and Sanket Kanjalkar came
back to me a couple days later. They asked for a 4 weeks embargo on the details and silently fixed
the vulnerability in rust-miniscript [PR
#798](https://github.com/rust-bitcoin/rust-miniscript/pull/798). The fix was then
[backported](https://github.com/rust-bitcoin/rust-miniscript/pull/803) to the `12.x` release branch
and a [`12.3.1`](https://github.com/rust-bitcoin/rust-miniscript/releases/tag/12.3.1) version was
released on April 1st. They also responded to this incident by [increasing the fuzz
coverage](https://github.com/rust-bitcoin/rust-miniscript/pull/798/files#diff-03aa9083322d882a6788541078684e30a3770162a9ba3ead5453d21d5d3593f3)
of their satisfier.

I'd like to thank the Rust-Miniscript maintainers Andrew Poelstra and Sanket Kanjalkar for the swift
reply and the no-bullshit communication throughout this report. Thanks to the Wizardsardine team, and
@Pythcoiner in particular, for identifying the crash in the first place. Finally, thanks to
[Chaincode Labs](https://chaincode.com) for sponsoring my Bitcoin open source work.

[GH permalink]: https://github.com/rust-bitcoin/rust-miniscript/blob/e6404b77b819a6e8477f34ee2561f69631643d0e/src/miniscript/satisfy.rs#L1029
