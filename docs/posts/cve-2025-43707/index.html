<!doctype html>
<html lang="en-us">
<head>
    <title>Antoine Poinsot - CVE-2025-43707: out-of-bounds read in the Rust-Miniscript satisfier</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Public disclosure of a crash bug in the Rust-Miniscript library" />

    <meta property="og:url" content="https://antoinep.com/posts/cve-2025-43707/">
  <meta property="og:site_name" content="Antoine Poinsot">
  <meta property="og:title" content="CVE-2025-43707: out-of-bounds read in the Rust-Miniscript satisfier">
  <meta property="og:description" content="Public disclosure of a crash bug in the Rust-Miniscript library">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-24T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-04-24T00:00:00+00:00">
    <meta property="article:tag" content="Miniscript">
    <meta property="article:tag" content="Rust-Miniscript">
    <meta property="article:tag" content="Infosec">

    <meta name="og:image" content="https://antoinep.com/images/kebab_bordeaux.jpg" /> 

    
    
    
    <link rel="stylesheet" href="../../css/theme.min.css">

    
    
    
    
    <link rel="stylesheet" href="../../css/custom.min.css">
    

    
</head>
<body>
        <div id="content" class="mx-auto"><header class="container mt-sm-5 mt-4 mb-4 mt-xs-1">
    <div class="row">
        
        <div class="col-sm-4 col-12 text-sm-right text-center pt-sm-4">
            <a href="../../" class="text-decoration-none">
                <img id="home-image" class="rounded-circle"
                    
                        
                            src="../../images/kebab_bordeaux.jpg"
                        
                    
                />
            </a>
        </div>
        <div class="col-sm-8 col-12 text-sm-left text-center">
        
            <h2 class="m-0 mb-2 mt-4">
                <a href="../../" class="text-decoration-none">
                    
                        Antoine Poinsot
                    
                </a>
            </h2>
            <p class="text-muted mb-1">
                
                    590B 7292 695A FFA5 B672 CBB2 E13F C145 CD3F 4304
                
            </p>
            <ul id="nav-links" class="list-inline mb-2">
                
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../" title="About">About</a>
                    </li>
                
                    <li class="list-inline-item">
                        <a class="badge badge-white " href="../../posts/" title="Posts">Posts</a>
                    </li>
                
            </ul>
            <ul id="nav-social" class="list-inline">
                
                    <li class="list-inline-item mr-3">
                        <a href="https://twitter.com/darosior" target="_blank">
                            <i class="fab fa-twitter fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="http://github.com/darosior" target="_blank">
                            <i class="fab fa-github fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://www.linkedin.com/in/antoine-p/" target="_blank">
                            <i class="fab fa-linkedin-in fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="https://bsky.app/profile/darosior.bsky.social" target="_blank">
                            <i class="fab fa-bluesky fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="mailto:darosior@protonmail.com" target="_blank">
                            <i class="fa-solid fa-envelope fa-1x text-muted"></i>
                        </a>
                    </li>
                
                    <li class="list-inline-item mr-3">
                        <a href="../../0xE13FC145CD3F4304.asc" target="_blank">
                            <i class="fa-solid fa-key fa-1x text-muted"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
    <hr />
</header>
<div class="container">
    <div class="pl-sm-4 ml-sm-5">
        <p>On March 25, <a href="https://github.com/pythcoiner">@Pythcoiner</a> from the
<a href="https://wizardsardine.com">Wizardsardine</a> team contacted me about a crash bug
in <a href="https://github.com/wizardsardine/liana">Liana</a> they had identified as
coming from the
<a href="https://github.com/rust-bitcoin/rust-miniscript"><code>rust-miniscript</code></a>
dependency. After investigating i identified the crash as coming from the
library&rsquo;s Miniscript satisfier, and found it could be triggered by an attacker.</p>
<p>The impact of this vulnerability is that an attacker could make a victim crash by getting them to
satisfy a transaction spending a specially-crafted descriptor. In simpler terms, a victim could
crash when &ldquo;signing&rdquo; a transaction that spends from a specific &ldquo;wallet&rdquo;. This is not critical (but
still pretty annoying!) if you consider the victim as being a software running locally. But these
are pretty common operations and it would not be surprising that an application running on a server
publicly exposes them (for instance through <a href="https://bitcoindevkit.org/adoption/all">BDK</a>). There,
an attacker exploiting this bug could prevent all users from accessing the service.</p>
<p>The bug itself is an out-of-bounds read in the <a href="https://github.com/rust-bitcoin/rust-miniscript/blob/e6404b77b819a6e8477f34ee2561f69631643d0e/src/miniscript/satisfy.rs#L1029"><code>Satisfaction::thresh()</code></a> function.
This code assumes that the size of the <code>sat_indices</code> vector is strictly superior to the threshold
<code>k</code>. This is not always the case, as <code>thresh(2,A,B)</code> is valid Miniscript. Therefore trying to
satisfy any <code>thresh()</code> fragment with a threshold <code>k</code> equal to the number of sub-fragments will
trigger an out-of-bounds read in the <code>sat_indices</code> vector. It can be fixed with the following diff:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-patch" data-lang="patch"><span style="display:flex;"><span>diff --git a/src/miniscript/satisfy.rs b/src/miniscript/satisfy.rs
</span></span><span style="display:flex;"><span>index d141340..cca7051 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/src/miniscript/satisfy.rs
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/src/miniscript/satisfy.rs
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -1026,7 +1026,8 @@ impl&lt;Pk: MiniscriptKey + ToPublicKey&gt; Satisfaction&lt;Placeholder&lt;Pk&gt;&gt; {
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         // For example, the fragment thresh(2, hash, hash, 0, 0)
</span></span><span style="display:flex;"><span>         // is uniquely satisfyiable because there is no satisfaction
</span></span><span style="display:flex;"><span>         // for the 0 fragment
</span></span><span style="display:flex;"><span><span style="color:#f92672">-        else if !sats[sat_indices[thresh.k()]].has_sig
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+        else if sat_indices.len() &gt; thresh.k()
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+            &amp;&amp; !sats[sat_indices[thresh.k()]].has_sig
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>             &amp;&amp; sats[sat_indices[thresh.k()]].stack != Witness::Impossible
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>             // All arguments should be `d`, so dissatisfactions have no
</span></span></code></pre></div><p>I reported this issue according to <a href="https://github.com/rust-bitcoin/rust-bitcoin/blob/master/SECURITY.md"><code>rust-bitcoin</code>&rsquo;s security
policy</a> by emailing Andrew
Poelstra on March 25th, who acknowledged receipt on the same day. Andrew and Sanket Kanjalkar came
back to me a couple days later. They asked for a 4 weeks embargo on the details and silently fixed
the vulnerability in rust-miniscript <a href="https://github.com/rust-bitcoin/rust-miniscript/pull/798">PR
#798</a>. The fix was then
<a href="https://github.com/rust-bitcoin/rust-miniscript/pull/803">backported</a> to the <code>12.x</code> release branch
and a <a href="https://github.com/rust-bitcoin/rust-miniscript/releases/tag/12.3.1"><code>12.3.1</code></a> version was
released on April 1st. They also responded to this incident by <a href="https://github.com/rust-bitcoin/rust-miniscript/pull/798/files#diff-03aa9083322d882a6788541078684e30a3770162a9ba3ead5453d21d5d3593f3">increasing the fuzz
coverage</a>
of their satisfier.</p>
<p>I&rsquo;d like to thank the Rust-Miniscript maintainers Andrew Poelstra and Sanket Kanjalkar for the swift
reply and the no-bullshit communication throughout this report. Thanks to the Wizardsardine team, and
@Pythcoiner in particular, for identifying the crash in the first place. Finally, thanks to
<a href="https://chaincode.com">Chaincode Labs</a> for sponsoring my Bitcoin open source work.</p>

    </div>

    

            </div>
        </div><footer class="text-center pb-1">
    <small class="text-muted">
        
             
        
        <br>
        Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>
        and <a href="https://github.com/austingebauer/devise" target="_blank">Devise</a>
    </small>
</footer>
</body>
</html>
